//******************************************************************************
//* epgr.js: openwebif EPGRefresh plugin
//* Version 1.3
//******************************************************************************
//* Copyright (C) 2014-2016 Joerg Bleyel
//* Copyright (C) 2014-2016 E2OpenPlugins
//*
//* License GPL V2
//* https://github.com/E2OpenPlugins/e2openplugin-OpenWebif/blob/master/LICENSE.txt
//*******************************************************************************
function toUnixDate(e){var t=e.split("."),n=new Date;return n.setFullYear(t[2],t[1]-1,t[0]),n.setHours(0),n.setMinutes(0),n.setSeconds(0),Math.floor(n.getTime()/1e3)}function addZero(e){return 10>e&&(e="0"+e),e}function isBQ(e){return e.indexOf("FROM BOUQUET")>-1&&0!=e.indexOf("1:134:1")}function isAlter(e){return 0==e.indexOf("1:134:1")}!function(){var e=function(){var e;return{setup:function(){e=this,$("#er_begin").val("22:30"),$("#er_end").val("6:30"),$("#er_begin").timepicker(),$("#er_end").timepicker(),$("#bouquets").chosen({disable_search_threshold:10,no_results_text:"Oops, nothing found!",width:"100%"}),$("#bouquets").chosen().change(function(){$("#bouquets").val($(this).val()),e.er_bqchchanged=!0}),$("#channels").chosen({disable_search_threshold:10,no_results_text:"Oops, nothing found!",width:"100%"}),$("#channels").chosen().change(function(){$("#channels").val($(this).val()),e.er_bqchchanged=!0}),$(".chosen-container .chosen-drop").addClass("ui-widget-content"),"eggplant"!=theme&&"vader"!=theme||$(".chosen-container .chosen-drop").css("background-image","none"),e.getAllServices(),$("#actions").buttonset(),$("#epgrbutton0").click(function(){e.reloadEPGR()}),$("#epgrbutton0").button({icons:{primary:"ui-icon-arrowrefresh-1-w"}}),$("#epgrbutton1").click(function(){e.saveEPGR()}),$("#epgrbutton1").button({icons:{primary:"ui-icon-disk"}}),$("#epgrbutton2").click(function(){e.DoRefresh()}),$("#statuscont").hide()},getAllServices:function(){GetAllServices(function(t,n){$("#channels").append(t),$("#channels").trigger("chosen:updated"),$("#bouquets").append(n),$("#bouquets").trigger("chosen:updated"),e.reloadEPGR()})},reloadEPGR:function(){e.showError(""),$.ajax({type:"GET",url:"/epgrefresh",dataType:"xml",success:function(t){e.readEPGR2(t)},error:function(t){e.showError(t.responseText)}})},readEPGR2:function(t){var n,r;e.er_hasAutoTimer=!1,$.ajax({type:"GET",url:"/epgrefresh/get",dataType:"xml",success:function(s){$(s).find("e2setting").each(function(){var t=$(this).find("e2settingname").text(),s=$(this).find("e2settingvalue").text();0===t.indexOf("config.plugins.epgrefresh.")?(t=t.substring(26),"True"===s?$("#er_"+t).prop("checked",!0):"False"===s?$("#er_"+t).prop("checked",!1):"begin"===t?n=s:"end"===t?r=s:"interval_seconds"==t?(e.binterval_in_seconds=!0,$("#er_interval").val(s)):"interval"==t?(e.binterval_in_seconds=!1,$("#er_interval").val(s)):$("#er_"+t).val(s)):"hasAutoTimer"===t&&"True"===s&&(e.er_hasAutoTimer=!0)}),e.UpdateCHBQ(t,n,r)},error:function(t){e.showError(t.responseText)}})},UpdateCHBQ:function(t,n,r){var s=parseInt(n),a=new Date(1e3*s),o=addZero(a.getHours()),i=addZero(a.getMinutes());$("#er_begin").val(o+":"+i),s=parseInt(r),a=new Date(1e3*s),o=addZero(a.getHours()),i=addZero(a.getMinutes()),$("#er_end").val(o+":"+i);var c=[],u=[];$(t).find("e2service").each(function(){var e=$(this).find("e2servicereference").text();isBQ(e)?u.push(encodeURIComponent(e)):isAlter(e)?c.push(encodeURIComponent(e)):c.push(e)});var l=c.slice(),d=u.slice();$("#channels").val(null),$("#bouquets").val(null),$.each(d,function(e,t){$('#bouquets option[value="'+t+'"]').prop("selected",!0)}),$.each(l,function(e,t){$('#channels option[value="'+t+'"]').prop("selected",!0)}),$("#bouquets").trigger("chosen:updated"),$("#channels").trigger("chosen:updated"),e.er_bqchchanged=!1,e.binterval_in_seconds?($("#lbls").show(),$("#lblm").hide()):($("#lblm").show(),$("#lbls").hide()),e.er_hasAutoTimer?$("#er_hasAT").show():$("#er_hasAT").hide()},saveEPGR:function(){var t="/epgrefresh/set?&enabled=";t+=$("#er_enabled").is(":checked")?"true":"",t+="&enablemessage=",t+=$("#er_enablemessage").is(":checked")?"true":"",$("#er_ebegin").is(":checked")&&(t+="&begin="+toUnixDate($("#er_begin").val())),$("#er_eend").is(":checked")&&(t+="&end="+toUnixDate($("#er_end").val())),t+="&delay_standby="+$("#er_delay_standby").val(),t+="&afterevent=",t+=$("#er_afterevent").is(":checked")?"true":"",t+="&force=",t+=$("#er_force").is(":checked")?"true":"",t+="&wakeup=",t+=$("#er_wakeup").is(":checked")?"true":"",t+="&adapter="+$("#er_adapter").val(),e.er_hasAutoTimer&&(t+="&inherit_autotimer=",t+=$("#er_inherit_autotimer").is(":checked")?"true":"",t+="&parse_autotimer="+$("#er_parse_autotimer").val()),t+=e.binterval_in_seconds?"&interval_seconds="+$("#er_interval").val():"&interval="+$("#er_interval").val(),$.ajax({type:"GET",url:t,dataType:"xml",success:function(t){var n=$(t).find("e2state").first(),r=$(t).find("e2statetext").first();e.showError(r.text(),n.text()),n&&e.SaveCHBQ()},error:function(t){e.showError(t.responseText)}})},SaveCHBQ:function(){if(e.er_bqchchanged!==!1){var t="",n=$("#bouquets").chosen().val(),r=$("#channels").chosen().val();r&&r.length>0&&$.each(r,function(e,n){t+=isAlter(n)?"&sref="+n:"&sref="+encodeURIComponent(n)}),n&&n.length>0&&$.each(n,function(e,n){t+="&sref="+n});var s="/epgrefresh/add?multi=1";""!=t&&(s+=t,$.ajax({type:"GET",url:s,dataType:"xml",success:function(t){var n=$(t).find("e2state").first(),r=$(t).find("e2statetext").first();e.showError(r.text(),n.text())},error:function(t){e.showError(t.responseText)}}))}},DoRefresh:function(){$.ajax({type:"GET",url:"/epgrefresh/refresh",dataType:"xml",success:function(t){var n=$(t).find("e2state").first(),r=$(t).find("e2statetext").first();e.showError(r.text(),n.text())},error:function(t){e.showError(t.responseText)}})},showError:function(e,t){t="undefined"!=typeof t?t:"False",$("#statustext").text(""),t===!0||"True"===t||"true"===t?($("#statusbox").removeClass("ui-state-error").addClass("ui-state-highlight"),$("#statusicon").removeClass("ui-icon-alert").addClass("ui-icon-info")):($("#statusbox").removeClass("ui-state-highlight").addClass("ui-state-error"),$("#statusicon").removeClass("ui-icon-info").addClass("ui-icon-alert")),$("#statustext").text(e),""!==e?$("#statuscont").show():$("#statuscont").hide()}}},t=new e;t.setup()}();


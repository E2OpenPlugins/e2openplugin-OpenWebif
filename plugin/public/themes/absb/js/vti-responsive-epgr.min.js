function toUnixDate(e){var r=e.split(":"),t=new Date;return t.setHours(r[0]),t.setMinutes(r[1]),t.setSeconds(0),Math.floor(t.getTime()/1e3)}function addZero(e){return 10>e&&(e="0"+e),e}function isBQ(e){return e.indexOf("FROM BOUQUET")>-1&&0!=e.indexOf("1:134:1")}function isAlter(e){return 0==e.indexOf("1:134:1")}!function(){var e=function(){var e;return{setup:function(){e=this,$("#er_begin").val("22:30"),$("#er_end").val("6:30"),$("#bouquets").change(function(){$("#bouquets").val($(this).val()),e.er_bqchchanged=!0}),$("#channels").change(function(){$("#channels").val($(this).val()),e.er_bqchchanged=!0}),e.getAllServices(),$("#epgrbutton0").click(function(){e.reloadEPGR()}),$("#epgrbutton0").button({icons:{primary:"ui-icon-arrowrefresh-1-w"}}),$("#epgrbutton1").click(function(){e.saveEPGR()}),$("#epgrbutton1").button({icons:{primary:"ui-icon-disk"}}),$("#epgrbutton2").click(function(){e.DoRefresh()}),$("#statuscont").hide()},getAllServices:function(){GetAllServices(function(r,t){$("#bouquets").hide(),$("#channels").hide(),$("#channels").append(r),$("#channels").selectpicker("refresh"),$("#bouquets").append(t),$("#bouquets").selectpicker("refresh"),e.reloadEPGR(),$("#bouquets").show(),$("#channels").show()})},reloadEPGR:function(){e.showError(""),$.ajax({type:"GET",url:"/epgrefresh",dataType:"xml",success:function(r){e.readEPGR2(r)},error:function(r){e.showError(r.responseText)}})},readEPGR2:function(r){var t,n;e.er_hasAutoTimer=!1,$.ajax({type:"GET",url:"/epgrefresh/get",dataType:"xml",success:function(s){$(s).find("e2setting").each(function(){var r=$(this).find("e2settingname").text(),s=$(this).find("e2settingvalue").text();0===r.indexOf("config.plugins.epgrefresh.")?(r=r.substring(26),"True"===s?$("#er_"+r).prop("checked",!0):"False"===s?$("#er_"+r).prop("checked",!1):"begin"===r?t=s:"end"===r?n=s:"interval_seconds"==r?(e.binterval_in_seconds=!0,$("#er_interval").val(s)):"interval"==r?(e.binterval_in_seconds=!1,$("#er_interval").val(s)):$("#er_"+r).val(s)):"hasAutoTimer"===r&&"True"===s&&(e.er_hasAutoTimer=!0)}),e.UpdateCHBQ(r,t,n)},error:function(r){e.showError(r.responseText)}})},UpdateCHBQ:function(r,t,n){var s=parseInt(t),a=new Date(1e3*s),i=addZero(a.getHours()),o=addZero(a.getMinutes());$("#er_begin").val(i+":"+o),s=parseInt(n),a=new Date(1e3*s),i=addZero(a.getHours()),o=addZero(a.getMinutes()),$("#er_end").val(i+":"+o);var c=[],u=[];$(r).find("e2service").each(function(){var e=$(this).find("e2servicereference").text();isBQ(e)?u.push(encodeURIComponent(e)):isAlter(e)?c.push(encodeURIComponent(e)):c.push(e)});var l=c.slice(),h=u.slice();$("#channels").val(null),$("#bouquets").val(null),$.each(h,function(e,r){$('#bouquets option[value="'+r+'"]').prop("selected",!0)}),$.each(l,function(e,r){$('#channels option[value="'+r+'"]').prop("selected",!0)}),$("#bouquets").hide(),$("#channels").hide(),$("#bouquets").selectpicker("refresh"),$("#channels").selectpicker("refresh"),$("#bouquets").show(),$("#channels").show(),e.er_bqchchanged=!1,e.binterval_in_seconds?($("#lbls").show(),$("#lblm").hide()):($("#lblm").show(),$("#lbls").hide()),e.er_hasAutoTimer?$("#er_hasAT").show():$("#er_hasAT").hide()},saveEPGR:function(){var r="/epgrefresh/set?&enabled=";r+=$("#er_enabled").is(":checked")?"true":"",r+="&enablemessage=",r+=$("#er_enablemessage").is(":checked")?"true":"",r+="&begin="+toUnixDate($("#er_begin").val()),r+="&end="+toUnixDate($("#er_end").val()),r+="&delay_standby="+$("#er_delay_standby").val(),r+="&afterevent=",r+=$("#er_afterevent").is(":checked")?"true":"",r+="&force=",r+=$("#er_force").is(":checked")?"true":"",r+="&wakeup=",r+=$("#er_wakeup").is(":checked")?"true":"",r+="&adapter="+$("#er_adapter").val(),e.er_hasAutoTimer&&(r+="&inherit_autotimer=",r+=$("#er_inherit_autotimer").is(":checked")?"true":"",r+="&parse_autotimer="+$("#er_parse_autotimer").val()),r+=e.binterval_in_seconds?"&interval_seconds="+$("#er_interval").val():"&interval="+$("#er_interval").val(),$.ajax({type:"GET",url:r,dataType:"xml",success:function(r){var t=$(r).find("e2state").first(),n=$(r).find("e2statetext").first();e.showError(n.text(),t.text()),t&&e.SaveCHBQ()},error:function(r){e.showError(r.responseText)}})},SaveCHBQ:function(){if(e.er_bqchchanged!==!1){var r="",t=$("#bouquets").val(),n=$("#channels").val();n&&n.length>0&&$.each(n,function(e,t){r+=isAlter(t)?"&sref="+t:"&sref="+encodeURIComponent(t)}),t&&t.length>0&&$.each(t,function(e,t){r+="&sref="+t});var s="/epgrefresh/add?multi=1";""!=r&&(s+=r,$.ajax({type:"GET",url:s,dataType:"xml",success:function(r){var t=$(r).find("e2state").first(),n=$(r).find("e2statetext").first();e.showError(n.text(),t.text())},error:function(r){e.showError(r.responseText)}}))}},DoRefresh:function(){$.ajax({type:"GET",url:"/epgrefresh/refresh",dataType:"xml",success:function(r){var t=$(r).find("e2state").first(),n=$(r).find("e2statetext").first();e.showError(n.text(),t.text())},error:function(r){e.showError(r.responseText)}})},showError:function(e,r){r="undefined"!=typeof r?r:"False";var t="error";r!==!0&&"True"!==r&&"true"!==r||(t="success"),""!==e?swal("",e,t):$("#statuscont").hide()}}},r=new e;r.setup()}();

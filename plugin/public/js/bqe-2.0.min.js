//******************************************************************************
//* bqe.js: openwebif Bouqueteditor plugin
//* Version 2.0
//******************************************************************************
//* Copyright (C) 2014-2016 Joerg Bleyel
//* Copyright (C) 2014-2016 E2OpenPlugins
//*
//* Authors: Joerg Bleyel <jbleyel # gmx.net>
//*          Robert Damas <https://github.com/rdamas>

//* V 2.0 - complete refactored

//* License GPL V2
//* https://github.com/E2OpenPlugins/e2openplugin-OpenWebif/blob/master/LICENSE.txt
//*******************************************************************************
// TODO: alternatives
!function(){var e=function(){var e;return{showProviders:function(t){$("#sel0").show(),$("#btn-provider-add").show().prop("disabled",1!==e.cType),$("#channels").empty(),$("#provider").html(t).children().first().addClass("ui-selected"),e.changeProvider($("#provider").children().first().data("sref"),e.showChannels)},showChannels:function(t){$("#channels").html(t),e.setChannelButtons()},showBouquets:function(t){$("#bql").html(t).children().first().addClass("ui-selected"),e.changeBouquet($("#bql").children().first().data("sref"),e.showBouquetChannels)},showBouquetChannels:function(t){$("#bqs").html(t),e.setBouquetChannelButtons()},buildRefStr:function(t){var o;return o=0===e.Mode?"1:7:1:0:0:0:0:0:0:0:(type == 1) || (type == 17) || (type == 195) || (type == 25) || (type == 22) || (type == 31) || (type == 211) ":"1:7:2:0:0:0:0:0:0:0:(type == 2) ",0===t?(o+='FROM BOUQUET "bouquets.',o+=0===e.Mode?"tv":"radio",o+='" ORDER BY bouquet'):1===t?o+="FROM PROVIDERS ORDER BY name":2===t?o+="FROM SATELLITES ORDER BY satellitePosition":3===t&&(o+="ORDER BY name"),encodeURIComponent(o)},setTvRadioMode:function(t){var o=!1;t===e.Mode&&3!==t||(o=!0),t>1?e.Mode=0:e.Mode=t,0===e.cType?e.getSatellites(e.showProviders):1===e.cType?e.getProviders(e.showProviders):2===e.cType&&($("#sel0").hide(),e.getChannels(e.showChannels)),o&&e.getBouquets(e.showBouquets)},getSatellites:function(t){e.cType=0;var o=e.buildRefStr(2);$.getJSON("/api/getsatellites?sRef="+o,function(e){var o="",n=e.satellites;$.each(n,function(e,t){var n=t.service,s=t.name;o+='<li class="ui-widget-content" data-sref="'+encodeURIComponent(n)+'">'+s+"</li>"}),t&&t(o)})},getProviders:function(t){e.cType=1;var o=e.buildRefStr(1);$.getJSON("/api/getservices?sRef="+o,function(e){var o="",n=e.services;$.each(n,function(e,t){var n=t.servicereference,s=t.servicename;o+='<li class="ui-widget-content" data-sref="'+encodeURIComponent(n)+'">'+s+"</li>"}),t&&t(o)})},getChannels:function(t){e.cType=2;var o=e.buildRefStr(3);$.getJSON("/api/getservices?sRef="+o,function(o){var n="",s=o.services;$.each(s,function(t,o){var s=o.servicereference,a=o.servicename,i=s.split(":")[2],r='<span class="marker">'+(e.sType[i]||"")+"</span>";n+='<li class="ui-widget-content" data-stype="'+i+'" data-sref="'+encodeURIComponent(s)+'">'+a+r+"</li>"}),t&&t(n)})},getBouquets:function(t){var o=e.buildRefStr(0);$.getJSON("/bouqueteditor/api/getservices?sRef="+o,function(e){var o="",n=e.services;$.each(n,function(e,t){var n=t.servicereference,s=t.servicename;o+='<li class="ui-widget-content" data-sref="'+encodeURIComponent(n)+'"><div class="handle"><span class="ui-icon ui-icon-carat-2-n-s"></span></div>'+s+"</li>"}),t&&t(o)})},changeProvider:function(t,o){$.getJSON("/api/getservices?sRef="+t,function(t){var n="",s=t.services;$.each(s,function(t,o){var s=o.servicereference,a=o.servicename,i=s.split(":")[2],r='<span class="marker">'+(e.sType[i]||"")+"</span>";n+='<li class="ui-widget-content" data-stype="'+i+'" data-sref="'+encodeURIComponent(s)+'">'+a+r+"</li>"}),o&&o(n)})},changeBouquet:function(e,t){$.getJSON("/bouqueteditor/api/getservices?sRef="+e,function(e){var o="",n=e.services;$.each(n,function(e,t){var n=t.servicereference,s=t.servicename,a=1==t.ismarker?'<span style="float:right">(M)</span>':"";o+='<li class="ui-widget-content" data-ismarker="'+t.ismarker+'" data-sref="'+encodeURIComponent(n)+'"><div class="handle"><span class="ui-icon ui-icon-carat-2-n-s"></span></div>'+s+a+"</li>"}),t&&t(o)})},addProvider:function(){var t=$("#provider li.ui-selected").data("sref");$.getJSON("/bouqueteditor/api/addprovidertobouquetlist?sProviderRef="+t+"&mode="+e.Mode,function(t){var o=t.Result;2==o.length&&e.showError(o[1],o[0]),e.getBouquets(e.showBouquets)})},moveBouquet:function(e){$.getJSON("/bouqueteditor/api/movebouquet?sBouquetRef="+e.sBouquetRef+"&mode="+e.mode+"&position="+e.position,function(){})},addBouquet:function(){var t=prompt(tstr_bqe_name_bouquet+":");t.length&&$.getJSON("/bouqueteditor/api/addbouquet?name="+encodeURIComponent(t)+"&mode="+e.Mode,function(t){var o=t.Result;2==o.length&&e.showError(o[1],o[0]),e.getBouquets(e.showBouquets)})},renameBouquet:function(){if(1===$("#bql li.ui-selected").length){var t=$("#bql li.ui-selected"),o=(t.index(),t.text()),n=t.data("sref"),s=prompt(tstr_bqe_rename_bouquet+":",o);s&&s!=o&&$.getJSON("/bouqueteditor/api/renameservice?sRef="+n+"&mode="+e.Mode+"&newName="+encodeURIComponent(s),function(t){var o=t.Result;2==o.length&&e.showError(o[1],o[0]),e.getBouquets(e.showBouquets)})}},deleteBouquet:function(){if(1===$("#bql li.ui-selected").length){var t=$("#bql li.ui-selected").text(),o=$("#bql li.ui-selected").data("sref");confirm(tstr_bqe_del_bouquet_question+"\n"+t+" ?")!==!1&&$.getJSON("/bouqueteditor/api/removebouquet?sBouquetRef="+o+"&mode="+e.Mode,function(t){var o=t.Result;2==o.length&&e.showError(o[1],o[0]),e.getBouquets(e.showBouquets)})}},setChannelButtons:function(){var e=0==$("#channels li.ui-selected").length;$("#btn-channel-add").prop("disabled",e),$("#btn-alternative-add").prop("disabled",e)},setBouquetChannelButtons:function(){var e=$("#bqs li.ui-selected"),t=0==e.length;$("#btn-channel-delete").prop("disabled",t),$("#btn-marker-add").prop("disabled",t),t=1!=e.length||1!=e.data("ismarker"),$("#btn-marker-group-rename").prop("disabled",t)},moveChannel:function(e){$.getJSON("/bouqueteditor/api/moveservice?sBouquetRef="+e.sBouquetRef+"&sRef="+e.sRef+"&mode="+e.mode+"&position="+e.position,function(){})},addChannel:function(){var t=[],o=$("#bql li.ui-selected").data("sref"),n=$("#bqs li.ui-selected").data("sref")||"";$("#channels li.ui-selected").each(function(){t.push($.getJSON("/bouqueteditor/api/addservicetobouquet?sBouquetRef="+o+"&sRef="+$(this).data("sref")+"&sRefBefore="+n,function(){}))}),0!==t.length&&$.when.apply($,t).then(function(){e.changeBouquet(o,e.showBouquetChannels)})},addAlternative:function(){alert("NOT implemented YET")},deleteChannel:function(){if(0!==$("#bqs li.ui-selected").length){var t=$("#bql li.ui-selected").data("sref"),o=[],n=[],s="/bouqueteditor/api/removeservice?sBouquetRef="+t+"&mode="+e.Mode+"&sRef=";if($("#bqs li.ui-selected").each(function(){o.push($(this).text()),n.push(s+$(this).data("sref"))}),confirm(tstr_bqe_del_channel_question+"\n"+o.join(", ")+" ?")!==!1){var a=[];$.each(n,function(e,t){a.push($.getJSON(t,function(){}))}),0!==a.length&&$.when.apply($,a).then(function(){e.changeBouquet(t,e.showBouquetChannels)})}}},addMarker:function(){var t=prompt(tstr_bqe_name_marker+":");if(t.length){var o=$("#bql li.ui-selected").data("sref"),n=$("#bqs li.ui-selected").data("sref")||"";$.getJSON("/bouqueteditor/api/addmarkertobouquet?sBouquetRef="+o+"&Name="+encodeURIComponent(t)+"&sRefBefore="+n,function(t){var n=t.Result;2==n.length&&e.showError(n[1],n[0]),e.changeBouquet(o,e.showBouquetChannels)})}},renameMarkerGroup:function(){var t=$("#bqs li.ui-selected");if(1===t.length&&0!=t.data("ismarker")){var o=(t.index(),t.text()),n=t.data("sref"),s=$("#bql li.ui-selected").data("sref"),a=$("#bqs li.ui-selected").next().data("sref")||"",i=prompt(tstr_bqe_rename_marker+": ",o);i&&i!==o&&$.getJSON("/bouqueteditor/api/renameservice?sBouquetRef="+s+"&sRef="+n+"&newName="+encodeURIComponent(i)+"&sRefBefore="+a,function(t){var o=t.Result;2==o.length&&e.showError(o[1],o[0]),e.changeBouquet(s,e.showBouquetChannels)})}},searchChannel:function(t){var o=t.toLowerCase();$("#channels li").each(function(){-1!==$(this).text().toLowerCase().indexOf(o)?$(this).show():$(this).hide()}),$("#channels li.ui-selected").removeClass("ui-selected"),e.setChannelButtons()},showError:function(e,t){t="undefined"!=typeof t?t:"False",$("#success").text(""),$("#error").text(""),t===!0||"True"===t?$("#success").text(e):$("#error").text(e),""!==e?$("#errorbox").show():$("#errorbox").hide()},exportBouquets:function(){var e=prompt(tstr_bqe_filename+": ","bouquets_backup");e&&$.getJSON("/bouqueteditor/api/backup?Filename="+e,function(e){var t=e.Result;if(t[0]===!1)showError(t[1],t[0]);else{var o="/bouqueteditor/tmp/"+t[1];window.open(o,"Download")}})},importBouquets:function(){$("#rfile").trigger("click")},prepareRestore:function(){var t=$(this).val();t=t.replace("C:\\fakepath\\",""),confirm(tstr_bqe_restore_question+" ( "+t+") ?")!==!1&&($("form#uploadrestore").unbind("submit").submit(function(t){var o=new FormData(this);$.ajax({url:"/bouqueteditor/uploadrestore",type:"POST",data:o,mimeType:"multipart/form-data",contentType:!1,cache:!1,processData:!1,dataType:"json",success:function(t,o){var n=t.Result;n[0]?e.doRestore(n[1]):e.showError("Upload File: "+o)},error:function(t,o,n){e.showError("Upload File Error: "+n)}}),t.preventDefault();try{t.unbind()}catch(t){}}),$("form#uploadrestore").submit())},doRestore:function(t){t&&$.getJSON("/bouqueteditor/api/restore?Filename="+t,function(t){var o=t.Result;2==o.length&&e.showError(o[1],o[0])})},setup:function(){e=this,e.Mode=0,e.cType=1,e.sType={1:"[SD]",16:"[SD4]",19:"[HD]","1F":"[UHD]",D3:"[OPT]"},$("#tb1").buttonset(),$("#tb2").buttonset(),$("#tb3").buttonset(),$("#btn-provider-add").click(e.addProvider),$("#btn-channel-add").click(e.addChannel),$("#btn-alternative-add").click(e.addAlternative),$("#btn-bouquet-add").click(e.addBouquet),$("#btn-bouquet-rename").click(e.renameBouquet),$("#btn-bouquet-delete").click(e.deleteBouquet),$("#btn-channel-delete").click(e.deleteChannel),$("#btn-marker-add").click(e.addMarker),$("#btn-marker-group-rename").click(e.renameMarkerGroup),$("#provider").selectable({selected:function(t,o){$(o.selected).addClass("ui-selected").siblings().removeClass("ui-selected"),e.changeProvider($(o.selected).data("sref"),e.showChannels)},classes:{"ui-selected":"ui-state-active"}}),$("#channels").selectable({stop:e.setChannelButtons,classes:{"ui-selected":"ui-state-active"}}),$("#bql").sortable({handle:".handle",stop:function(t,o){var n=$(o.item).data("sref"),s=o.item.index();e.moveBouquet({sBouquetRef:n,mode:e.Mode,position:s})}}).selectable({filter:"li",cancel:".handle",selected:function(t,o){$(o.selected).addClass("ui-selected").siblings().removeClass("ui-selected"),e.changeBouquet($(o.selected).data("sref"),e.showBouquetChannels)},classes:{"ui-selected":"ui-state-active"}}),$("#bqs").sortable({handle:".handle",stop:function(t,o){var n=$("#bql li.ui-selected").data("sref"),s=$(o.item).data("sref"),a=o.item.index();e.moveChannel({sBouquetRef:n,sRef:s,mode:e.Mode,position:a})}}).selectable({filter:"li",cancel:".handle",stop:e.setBouquetChannelButtons,classes:{"ui-selected":"ui-state-active"}}),$("#toolbar-choose-tv").click(function(){e.setTvRadioMode(0)}),$("#toolbar-choose-radio").click(function(){e.setTvRadioMode(1)}),$("#toolbar-choose-satellites").click(function(){e.getSatellites(e.showProviders)}),$("#toolbar-choose-providers").click(function(){e.getProviders(e.showProviders)}),$("#toolbar-choose-channels").click(function(){$("#sel0").hide(),$("#btn-provider-add").hide(),e.getChannels(e.showChannels)}),$("#toolbar-bouquets-reload").click(function(){e.getBouquets(e.showBouquets)}),$("#toolbar-bouquets-export").click(e.exportBouquets),$("#toolbar-bouquets-import").click(e.importBouquets),$("#searchch").focus(function(){"..."===$(this).val()&&$(this).val("")}).keyup(function(){$(this).data("val")!==this.value&&e.searchChannel(this.value),$(this).data("val",this.value)}).blur(function(){$(this).data("val",""),""===$(this).val()&&$(this).val("...")}),$("#rfile").change(e.prepareRestore),e.setTvRadioMode(3)}}},t=new e;t.setup()}();

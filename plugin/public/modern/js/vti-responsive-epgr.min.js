function toUnixDate(e){var t=e.split(":"),e=new Date;return e.setHours(t[0]),e.setMinutes(t[1]),e.setSeconds(0),Math.floor(e.getTime()/1e3)}function addZero(e){return e<10&&(e="0"+e),e}function isBQ(e){return-1<e.indexOf("FROM BOUQUET")&&0!=e.indexOf("1:134:1")}function isAlter(e){return 0==e.indexOf("1:134:1")}(new function(){var c;return{setup:function(){c=this,$("#er_begin").val("22:30"),$("#er_end").val("6:30"),$("#bouquets").change(function(){$("#bouquets").val($(this).val()),c.er_bqchchanged=!0}),$("#channels").change(function(){$("#channels").val($(this).val()),c.er_bqchchanged=!0}),c.getAllServices(),$("#epgrbutton0").click(function(){c.reloadEPGR()}),$("#epgrbutton0").button({icons:{primary:"ui-icon-arrowrefresh-1-w"}}),$("#epgrbutton1").click(function(){c.saveEPGR()}),$("#epgrbutton1").button({icons:{primary:"ui-icon-disk"}}),$("#epgrbutton2").click(function(){c.DoRefresh()}),$("#statuscont").hide()},getAllServices:function(){niptv=EPGRnoiptv?"&noiptv=1":"",$.ajax({url:"/api/getallservices?nolastscanned=1"+niptv,dataType:"json",success:function(e){JSON.stringify(e);e=e.services;FillAllServices(e,function(e,t){$("#bouquets").hide(),$("#channels").hide(),$("#channels").append(e),$("#channels").selectpicker("refresh"),$("#bouquets").append(t),$("#bouquets").selectpicker("refresh"),c.reloadEPGR(),$("#bouquets").show(),$("#channels").show()})}})},reloadEPGR:function(){c.showError(""),$.ajax({type:"GET",url:"/epgrefresh",dataType:"xml",success:function(e){c.readEPGR2(e)},error:function(e,t,r){c.showError(e.responseText)}})},readEPGR2:function(t){var r,n;c.er_hasAutoTimer=!1,$.ajax({type:"GET",url:"/epgrefresh/get",dataType:"xml",success:function(e){$(e).find("e2setting").each(function(){var e=$(this).find("e2settingname").text(),t=$(this).find("e2settingvalue").text();0===e.indexOf("config.plugins.epgrefresh.")?(e=e.substring(26),"True"===t?$("#er_"+e).prop("checked",!0):"False"===t?$("#er_"+e).prop("checked",!1):"begin"===e?r=t:"end"===e?n=t:"interval_seconds"==e?(c.binterval_in_seconds=!0,$("#er_interval").val(t)):"interval"==e?(c.binterval_in_seconds=!1,$("#er_interval").val(t)):$("#er_"+e).val(t)):"hasAutoTimer"===e&&"True"===t&&(c.er_hasAutoTimer=!0)}),c.UpdateCHBQ(t,r,n)},error:function(e,t,r){c.showError(e.responseText)}})},UpdateCHBQ:function(e,t,r){var n=parseInt(t),s=new Date(1e3*n),a=addZero(s.getHours()),t=addZero(s.getMinutes());$("#er_begin").val(a+":"+t),n=parseInt(r),a=addZero((s=new Date(1e3*n)).getHours()),t=addZero(s.getMinutes()),$("#er_end").val(a+":"+t);var i=[],o=[];$(e).find("e2service").each(function(){var e=$(this).find("e2servicereference").text();isBQ(e)?o.push(encodeURIComponent(e)):isAlter(e)?i.push(encodeURIComponent(e)):i.push(e)});t=i.slice(),e=o.slice();$("#channels").val(null),$("#bouquets").val(null),$.each(e,function(e,t){$('#bouquets option[value="'+t+'"]').prop("selected",!0)}),$.each(t,function(e,t){$('#channels option[value="'+t+'"]').prop("selected",!0)}),$("#bouquets").hide(),$("#channels").hide(),$("#bouquets").selectpicker("refresh"),$("#channels").selectpicker("refresh"),$("#bouquets").show(),$("#channels").show(),c.er_bqchchanged=!1,c.binterval_in_seconds?($("#lbls").show(),$("#lblm").hide()):($("#lblm").show(),$("#lbls").hide()),c.er_hasAutoTimer?$("#er_hasAT").show():$("#er_hasAT").hide()},saveEPGR:function(){var e="/epgrefresh/set?&enabled=";e+=$("#er_enabled").is(":checked")?"true":"",e+="&enablemessage=",e+=$("#er_enablemessage").is(":checked")?"true":"",e+="&begin="+toUnixDate($("#er_begin").val()),e+="&end="+toUnixDate($("#er_end").val()),e+="&delay_standby="+$("#er_delay_standby").val(),e+="&afterevent=",e+=$("#er_afterevent").is(":checked")?"true":"",e+="&force=",e+=$("#er_force").is(":checked")?"true":"",e+="&wakeup=",e+=$("#er_wakeup").is(":checked")?"true":"",e+="&adapter="+$("#er_adapter").val(),c.er_hasAutoTimer&&(e+="&inherit_autotimer=",e+=$("#er_inherit_autotimer").is(":checked")?"true":"",e+="&parse_autotimer="+$("#er_parse_autotimer").val()),c.binterval_in_seconds?e+="&interval_seconds="+$("#er_interval").val():e+="&interval="+$("#er_interval").val(),$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var t=$(e).find("e2state").first(),e=$(e).find("e2statetext").first();c.showError(e.text(),t.text()),t&&c.SaveCHBQ()},error:function(e,t,r){c.showError(e.responseText)}})},SaveCHBQ:function(){var r,e,t;!1!==c.er_bqchchanged&&(r="",t=$("#bouquets").val(),(e=$("#channels").val())&&0<e.length&&$.each(e,function(e,t){isAlter(t)?r+="&sref="+t:r+="&sref="+encodeURIComponent(t)}),t&&0<t.length&&$.each(t,function(e,t){r+="&sref="+t}),t="/epgrefresh/add?multi=1",""!=r&&(t+=r,$.ajax({type:"GET",url:t,dataType:"xml",success:function(e){var t=$(e).find("e2state").first(),e=$(e).find("e2statetext").first();c.showError(e.text(),t.text())},error:function(e,t,r){c.showError(e.responseText)}})))},DoRefresh:function(){$.ajax({type:"GET",url:"/epgrefresh/refresh",dataType:"xml",success:function(e){var t=$(e).find("e2state").first(),e=$(e).find("e2statetext").first();c.showError(e.text(),t.text())},error:function(e,t,r){c.showError(e.responseText)}})},showError:function(e,t){t=void 0!==t?t:"False",""!==e?swal("",e,!0!==t&&"True"!==t&&"true"!==t?"error":"success"):$("#statuscont").hide()}}}).setup();
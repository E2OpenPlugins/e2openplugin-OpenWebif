function toUnixDate(e){var t=e.split(":"),r=new Date;return r.setHours(t[0]),r.setMinutes(t[1]),r.setSeconds(0),Math.floor(r.getTime()/1e3)}function addZero(e){return e<10&&(e="0"+e),e}function isBQ(e){return e.indexOf("FROM BOUQUET")>-1&&0!=e.indexOf("1:134:1")}function isAlter(e){return 0==e.indexOf("1:134:1")}(new function(){var e;return{setup:function(){e=this,$("#er_begin").val("22:30"),$("#er_end").val("6:30"),$("#bouquets").change((function(){$("#bouquets").val($(this).val()),e.er_bqchchanged=!0})),$("#channels").change((function(){$("#channels").val($(this).val()),e.er_bqchchanged=!0})),e.getAllServices(),$("#epgrbutton0").click((function(){e.reloadEPGR()})),$("#epgrbutton0").button({icons:{primary:"ui-icon-arrowrefresh-1-w"}}),$("#epgrbutton1").click((function(){e.saveEPGR()})),$("#epgrbutton1").button({icons:{primary:"ui-icon-disk"}}),$("#epgrbutton2").click((function(){e.DoRefresh()})),$("#statuscont").hide()},getAllServices:function(){niptv=EPGRnoiptv?"&noiptv=1":"",$.ajax({url:"/api/getallservices?nolastscanned=1"+niptv,dataType:"json",success:function(t){JSON.stringify(t);var r=t.services;FillAllServices(r,!1,(function(t,r){$("#bouquets").hide(),$("#channels").hide(),$("#channels").append(t),$("#channels").selectpicker("refresh"),$("#bouquets").append(r),$("#bouquets").selectpicker("refresh"),e.reloadEPGR(),$("#bouquets").show(),$("#channels").show()}))}})},reloadEPGR:function(){e.showError(""),$.ajax({type:"GET",url:"/epgrefresh",dataType:"xml",success:function(t){e.readEPGR2(t)},error:function(t,r,n){e.showError(t.responseText)}})},readEPGR2:function(t){var r,n;e.er_hasAutoTimer=!1,$.ajax({type:"GET",url:"/epgrefresh/get",dataType:"xml",success:function(s){$(s).find("e2setting").each((function(){var t=$(this).find("e2settingname").text(),s=$(this).find("e2settingvalue").text();0===t.indexOf("config.plugins.epgrefresh.")?(t=t.substring(26),"True"===s?$("#er_"+t).prop("checked",!0):"False"===s?$("#er_"+t).prop("checked",!1):"begin"===t?r=s:"end"===t?n=s:"interval_seconds"==t?(e.binterval_in_seconds=!0,$("#er_interval").val(s)):"interval"==t?(e.binterval_in_seconds=!1,$("#er_interval").val(s)):$("#er_"+t).val(s)):"hasAutoTimer"===t&&"True"===s&&(e.er_hasAutoTimer=!0)})),e.UpdateCHBQ(t,r,n)},error:function(t,r,n){e.showError(t.responseText)}})},UpdateCHBQ:function(t,r,n){var s=parseInt(r),a=new Date(1e3*s),i=addZero(a.getHours()),o=addZero(a.getMinutes());$("#er_begin").val(i+":"+o),s=parseInt(n),i=addZero((a=new Date(1e3*s)).getHours()),o=addZero(a.getMinutes()),$("#er_end").val(i+":"+o);var c=[],u=[];$(t).find("e2service").each((function(){var e=$(this).find("e2servicereference").text();isBQ(e)?u.push(encodeURIComponent(e)):isAlter(e)?c.push(encodeURIComponent(e)):c.push(e)}));var l=c.slice(),h=u.slice();$("#channels").val(null),$("#bouquets").val(null),$.each(h,(function(e,t){$('#bouquets option[value="'+t+'"]').prop("selected",!0)})),$.each(l,(function(e,t){$('#channels option[value="'+t+'"]').prop("selected",!0)})),$("#bouquets").hide(),$("#channels").hide(),$("#bouquets").selectpicker("refresh"),$("#channels").selectpicker("refresh"),$("#bouquets").show(),$("#channels").show(),e.er_bqchchanged=!1,e.binterval_in_seconds?($("#lbls").show(),$("#lblm").hide()):($("#lblm").show(),$("#lbls").hide()),e.er_hasAutoTimer?$("#er_hasAT").show():$("#er_hasAT").hide()},saveEPGR:function(){var t="/epgrefresh/set?&enabled=";t+=$("#er_enabled").is(":checked")?"true":"",t+="&enablemessage=",t+=$("#er_enablemessage").is(":checked")?"true":"",t+="&begin="+toUnixDate($("#er_begin").val()),t+="&end="+toUnixDate($("#er_end").val()),t+="&delay_standby="+$("#er_delay_standby").val(),t+="&afterevent=",t+=$("#er_afterevent").is(":checked")?"true":"",t+="&force=",t+=$("#er_force").is(":checked")?"true":"",t+="&wakeup=",t+=$("#er_wakeup").is(":checked")?"true":"",t+="&adapter="+$("#er_adapter").val(),e.er_hasAutoTimer&&(t+="&inherit_autotimer=",t+=$("#er_inherit_autotimer").is(":checked")?"true":"",t+="&parse_autotimer="+$("#er_parse_autotimer").val()),e.binterval_in_seconds?t+="&interval_seconds="+$("#er_interval").val():t+="&interval="+$("#er_interval").val(),$.ajax({type:"GET",url:t,dataType:"xml",success:function(t){var r=$(t).find("e2state").first(),n=$(t).find("e2statetext").first();e.showError(n.text(),r.text()),r&&e.SaveCHBQ()},error:function(t,r,n){e.showError(t.responseText)}})},SaveCHBQ:function(){if(!1!==e.er_bqchchanged){var t="",r=$("#bouquets").val(),n=$("#channels").val();n&&n.length>0&&$.each(n,(function(e,r){isAlter(r)?t+="&sref="+r:t+="&sref="+encodeURIComponent(r)})),r&&r.length>0&&$.each(r,(function(e,r){t+="&sref="+r}));var s="/epgrefresh/add?multi=1";""!=t&&(s+=t,$.ajax({type:"GET",url:s,dataType:"xml",success:function(t){var r=$(t).find("e2state").first(),n=$(t).find("e2statetext").first();e.showError(n.text(),r.text())},error:function(t,r,n){e.showError(t.responseText)}}))}},DoRefresh:function(){$.ajax({type:"GET",url:"/epgrefresh/refresh",dataType:"xml",success:function(t){var r=$(t).find("e2state").first(),n=$(t).find("e2statetext").first();e.showError(n.text(),r.text())},error:function(t,r,n){e.showError(t.responseText)}})},showError:function(e,t){var r="error";!0!==(t=void 0!==t?t:"False")&&"True"!==t&&"true"!==t||(r="success"),""!==e?swal("",e,r):$("#statuscont").hide()}}}).setup();
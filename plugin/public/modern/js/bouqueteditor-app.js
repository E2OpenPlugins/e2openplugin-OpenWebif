!function(){"use strict";String.prototype.customContainsText=function(e=""){if(!e)return!1;const t=this;let n=!1;return n=e.startsWith("^")?t.startsWith(e.slice(1)):e.endsWith("$")?t.endsWith(e.slice(0,-1)):t.includes(e),n};const e=(e,t={})=>fetch(e,t).then((e=>{if(e.ok)return e.json().then(((e,t=e.Result)=>t?(console.debug(t[1],t[0]),t):e))})).catch((e=>{console.debug(`apiRequest error: ${e}`)})),t={1:"SD",2:"Radio",16:"SD4",19:"HD","1F":"UHD",D3:"OPT"};class n{constructor(e){this.data={...e},this._sRefParts=this.data.servicereference.split(":"),this.data._ns=this._getNS(),this.data._stype=t[this._sRefParts[2]]||"Other",this.searchFields={servicename:this.normaliseText(this.data.servicename),provider:this.normaliseText(this.data.servicename),_stype:this.data._stype.toLowerCase()}}normaliseText(e){return e.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}containsText(e=""){const t=e.trim().toLowerCase();return this.searchFields.servicename.customContainsText(t)||this.searchFields.provider.customContainsText(t)||this.searchFields._stype.indexOf(t)>=0}_getNS(){let e="";const t=this._sRefParts[6].toLowerCase();if(t.startsWith("ffff",0))e="DVB-C";else if(t.startsWith("eeee",0))e="DVB-T";else{let n=parseInt(t,16)>>16&4095,s="E";n>1800&&(s="W",n=3600-n),e=`${(n/10).toFixed(1).toString()}&deg;${s}`}return e}}class s{constructor(e){this._panelEl=document.getElementById(e),this._jqEl=jQuery(this._panelEl),this._countEl=document.getElementById(`${e}__count`),this._templateEl=document.getElementById(`${e}-item-template`)}clearAll(){this._jqEl.empty()}addItem(e){this._panelEl.appendChild(e)}populate(e=[],t=(e=>e),n=!1){const s=this;s.clearAll(),s.itemCount=e.length,e.forEach((e=>{const n=s._templateEl.content.firstElementChild.cloneNode(!0);s.addItem(t(e,n))})),s.isLoading=!1,n&&s.selectFirstItem()}selectFirstItem(){try{this._panelEl.firstElementChild.classList.add("ui-selected")}catch(e){}}set isLoading(e){e?this._panelEl.classList.add("loading"):this._panelEl.classList.remove("loading")}set itemCount(e){this._countEl.textContent=`( ${e} )`}get selectedItems(){return this._panelEl.querySelectorAll(".ui-selected")}selectable(e){return this._jqEl.selectable(e)}sortable(e){return this._jqEl.sortable(e)}}(new function(){let t;const o=document.forms.listTypeSelector.elements.cType,a=document.forms.listTypeSelector.elements.tvRadioMode,r=new s("provider"),i=new s("channels"),l=new s("bql"),u=new s("bqs");return{getPlaylistUrl:e=>`/web/services.${GetLSValue("pl","m3u")}?bRef=${encodeURIComponent(e.servicereference)}&bName=${encodeURIComponent(e.servicename)}`,buildUrl:(e="",t={})=>(e=`${e}?`,Object.keys(t).forEach((n=>{e=e.concat(`${n}=${encodeURIComponent(t[n])}&`)})),e),buildRefStr:e=>{const n=t.getSelectedTvRadioMode();let s;switch(n){case 0:s="1:7:1:0:0:0:0:0:0:0:(type == 1) || (type == 17) || (type == 195) || (type == 25) || (type == 22) || (type == 31) || (type == 211) ";break;case 1:s="1:7:2:0:0:0:0:0:0:0:(type == 2) || (type == 10) ";break;default:s="1:7:1:0:0:0:0:0:0:0: "}switch(e){case 0:s=`${s} FROM BOUQUET "bouquets.${n<=0?"tv":"radio"}" ORDER BY bouquet`;break;case 1:s=`${s} FROM PROVIDERS ORDER BY name`;break;case 2:s=`${s} FROM SATELLITES ORDER BY satellitePosition`;break;case 3:default:s=`${s} ORDER BY name`}return s},getSelectedCType:()=>parseInt(o.value),getSelectedTvRadioMode:()=>parseInt(a.value),changeTvRadioMode:()=>{switch(document.querySelector('input[name="searchChannelsQuery"]').value="",t.getBouquets().then((e=>t.populateBouquets(e))),t.getSelectedCType()){case 1:t.getProviders().then((e=>t.populateProviders(e)));break;case 2:t.getSatellites().then((e=>t.populateProviders(e)));break;case 3:r.clearAll(),r.itemCount="ALL",t.getChannels().then((e=>t.populateChannels(e)))}},populateProviders:e=>{r.populate(e,((e,t)=>(t.dataset.sref=e.servicereference,t.dataset.sname=e.servicename,t.dataset.satprov=e._satprov,t.querySelector('slot[name="provider-name"]').innerHTML=e.servicename,t))),t.setProviderButtonsState(),t.getChannels().then((e=>t.populateChannels(e)))},populateChannels:()=>{i.populate(t.filterChannelsCache,((e,t)=>{let n=e.data,s=n.servicename;if(s){try{t.querySelector(".bqe__picon img").setAttribute("src",n.picon)}catch(e){}t.querySelector('slot[name="channel-name"]').innerHTML=s,t.querySelector(".item__metadata").setAttribute("title",n.provider),t.querySelector(".item__metadata").innerHTML=`${n._stype} &bull; ${n._ns}`,t.dataset.sref=n.servicereference,t.dataset.sname=n.servicename,t.querySelector('button[name="zap"]').onclick=()=>{zapChannel(n.servicereference,n.servicename)}}return t})),t.setChannelButtonsState()},populateBouquets:e=>{l.populate(e,((e,t)=>(t.dataset.sref=e.servicereference,t.dataset.sname=e.servicename,t.querySelector('slot[name="bouquet-name"]').innerHTML=e.servicename,t.querySelector('a[href="#playlistUrl"]').setAttribute("href",e.playlistUrl),t)),!0),t.changeBouquet(l.selectedItems[0].dataset.sref).then((e=>{t.populateBouquetChannels(e)}))},populateBouquetChannels:e=>{u.populate(e,((e,t)=>{let n=e.servicename;if(n&&0==e.ismarker){try{t.querySelector(".bqe__picon img").setAttribute("src",e.picon)}catch(e){}n=`${e.pos.toString()} - ${e.servicename}`,e.isprotected&&0!=e.isprotected&&(t.classList.add("item--is-protected"),t.querySelector(".item__protection").classList.remove("hidden"));const s=t.querySelector('button[name="stream"]');s.onclick=()=>{jumper8001(e.servicereference,e.servicename)},s.classList.remove("hidden");const o=t.querySelector('button[name="zap"]');o.onclick=()=>{zapChannel(e.servicereference,e.servicename)},o.classList.remove("hidden")}else{const n=t.querySelector(".item__marker");switch(t.classList.add("item--is-marker"),e.ismarker){case"1":n.textContent="[ M ]";break;case"2":n.textContent="[ S ]"}n.classList.remove("hidden")}return t.querySelector('slot[name="channel-name"]').innerHTML=n,t.dataset.sref=e.servicereference,t.dataset.sname=e.servicename,t.dataset.ismarker=e.ismarker,t})),t.setBouquetChannelButtonsState()},getSatellites:()=>new Promise((n=>{i.isLoading=!0;const s=t.buildUrl("/api/getsatellites",{sRef:t.buildRefStr(2),stype:t.getSelectedTvRadioMode()});e(s).then((e=>{const t=(e.satellites||[]).map((e=>(e.servicename=e.name,e.servicereference=e.service,e._satprov="satellite",e)));n(t)}))})),getProviders:()=>new Promise((n=>{i.isLoading=!0;const s=t.buildUrl("/api/getservices",{sRef:t.buildRefStr(1)});e(s).then((e=>{const t=(e.services||[]).map((e=>(e.servicename=e.servicename.replace("Â°","°"),e._satprov="provider",e)));n(t)}))})),getChannels:()=>new Promise((s=>{i.isLoading=!0;const o=t.buildUrl("/api/getservices",{sRef:t.buildRefStr(3),provider:1,picon:1});e(o).then((e=>{const o=(e.services||[]).map((e=>new n(e)));t.allChannelsCache=o,t.filterChannelsCache=o,s(o)}))})),getBouquets:()=>new Promise((n=>{const s=t.buildUrl("/bouqueteditor/api/getservices",{sRef:t.buildRefStr(0)});e(s).then((e=>{const s=(e.services||[]).map((e=>(e.servicename=e.servicename.replace("Â°","°"),e.playlistUrl=t.getPlaylistUrl(e),e)));n(s)}))})),changeProvider:s=>new Promise((o=>{i.isLoading=!0;const a=t.buildUrl("/api/getservices",{sRef:s,provider:1,picon:1});e(a).then((e=>{const s=(e.services||[]).map((e=>new n(e)));t.allChannelsCache=s,t.filterChannelsCache=s,o(s)}))})),changeBouquet:n=>new Promise((s=>{u.isLoading=!0;const o=t.buildUrl("/bouqueteditor/api/getservices",{sRef:n,picon:1});e(o).then((e=>{const t=e.services||[];s(t)}))})),addProviderAsBouquet:()=>{const n=t.buildUrl("/bouqueteditor/api/addprovidertobouquetlist",{sProviderRef:r.selectedItems[0].dataset.sref,mode:t.getSelectedTvRadioMode()});e(n).then((()=>{t.getBouquets().then((e=>t.populateBouquets(e)))}))},moveBouquet:n=>{const s=t.buildUrl("/bouqueteditor/api/movebouquet",{sBouquetRef:n.sBouquetRef,mode:n.mode,position:n.position});e(s).then((()=>{t.getBouquets().then((e=>t.populateBouquets(e)))}))},addBouquet:function(){swal({title:tstr_bqe_name_bouquet,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!0,inputValue:"",input:"text",animation:"none"},(n=>{if(!n||!n.length)return!1;const s=t.buildUrl("/bouqueteditor/api/addbouquet",{name:n,mode:t.getSelectedTvRadioMode()});e(s).then((()=>{t.getBouquets().then((e=>t.populateBouquets(e)))}))}))},renameBouquet:()=>{const n=l.selectedItems[0],s=n.dataset.sname;swal({title:tstr_bqe_rename_bouquet,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!0,inputValue:s,input:"text",animation:"none"},(o=>{if(!o||!o.length||o===s)return!1;const a=t.buildUrl("/bouqueteditor/api/renameservice",{sRef:n.dataset.sref,mode:t.getSelectedTvRadioMode(),newName:o});e(a).then((()=>{t.getBouquets().then((e=>t.populateBouquets(e)))}))}))},deleteBouquet:()=>{const n=l.selectedItems[0];swal({title:tstr_bqe_del_bouquet_question,text:n.dataset.sname,type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes_delete,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!0,closeOnCancel:!0,animation:"none"},(s=>{if(s){const s=t.buildUrl("/bouqueteditor/api/removebouquet",{sBouquetRef:n.dataset.sref,mode:t.getSelectedTvRadioMode()});e(s).then((()=>{t.getBouquets().then((e=>t.populateBouquets(e)))}))}}))},setProviderButtonsState:()=>{const e=r.selectedItems[0],t=e&&"provider"===e.dataset.satprov;document.querySelector('button[name="createBqFromProvider"]').disabled=!t},setChannelButtonsState:()=>{const e=i.selectedItems.length>0;document.querySelector('button[name="addChannelToBq"]').disabled=!e},setBouquetChannelButtonsState:()=>{const e=u.selectedItems,t=e.length>0,n=t&&1===e.length&&2!==e[0].dataset.ismarker;document.querySelector('button[name="removeService"]').disabled=!t,document.querySelector('button[name="renameService"]').disabled=!n},moveChannel:n=>{const s=t.buildUrl("/bouqueteditor/api/moveservice",{sBouquetRef:n.sBouquetRef,sRef:n.sRef,mode:n.mode,position:n.position});e(s).then((()=>t.renumberChannel()))},renumberChannel:()=>{},addChannel:()=>{const n=i.selectedItems,s=l.selectedItems[0].dataset.sref,o=u.selectedItems,a=o.length?o[0].dataset.sref:"",r=[];n.forEach((e=>{const n=t.buildUrl("/bouqueteditor/api/addservicetobouquet",{sBouquetRef:s,sRef:e.dataset.sref,sRefBefore:a});r.push(n)})),Promise.all(r.map((t=>e(t)))).then((e=>Promise.all(e))).then((()=>{t.changeBouquet(s).then((e=>t.populateBouquetChannels(e)))}))},deleteChannel:()=>{const n=u.selectedItems;if(!n.length)return!1;const s=l.selectedItems[0].dataset.sref,o=[],a=[];n.forEach((e=>{o.push(e.dataset.sname);const n=t.buildUrl("/bouqueteditor/api/removeservice",{sBouquetRef:s,mode:t.getSelectedTvRadioMode(),sRef:e.dataset.sref});a.push(n)})),swal({title:tstr_bqe_del_channel_question,text:o.join(", "),type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes_delete,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!0,closeOnCancel:!0,animation:"none"},(n=>{n&&Promise.all(a.map((t=>e(t)))).then((e=>Promise.all(e))).then((()=>{t.changeBouquet(s).then((e=>t.populateBouquetChannels(e)))}))}))},addAlternative:()=>{alert("Not implemented yet!")},addUrl:()=>{swal({title:tstr_bqe_add_url,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!1,animation:"fade",inputValue:"",input:"text",animation:"none"},(n=>{if(!n)return!1;swal({title:tstr_bqe_name_url,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!0,inputValue:n,input:"text",animation:"none"},(s=>{if(!n)return!1;const o=l.selectedItems[0].dataset.sref,a=u.selectedItems,r=a.length?a[0].dataset.sref:"",i=t.buildUrl("/bouqueteditor/api/addservicetobouquet",{sBouquetRef:o,Name:s,sRefBefore:r,sRefUrl:n});e(i).then((()=>{t.changeBouquet(o).then((e=>t.populateBouquetChannels(e)))}))}))}))},addSpacer:()=>{const n=l.selectedItems[0].dataset.sref,s=u.selectedItems,o=s.length?s[0].dataset.sref:"",a=t.buildUrl("/bouqueteditor/api/addmarkertobouquet",{sBouquetRef:n,SP:"1",sRefBefore:o});e(a).then((()=>{t.changeBouquet(n).then((e=>t.populateBouquetChannels(e)))}))},addMarker:()=>{swal({title:tstr_bqe_name_marker,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!0,inputValue:"",input:"text",animation:"none"},(n=>{if(!n||!n.length)return!1;const s=l.selectedItems[0].dataset.sref,o=u.selectedItems,a=o.length?o[0].dataset.sref:"",r=t.buildUrl("/bouqueteditor/api/addmarkertobouquet",{sBouquetRef:s,Name:n,sRefBefore:a});e(r).then((()=>{t.changeBouquet(s).then((e=>t.populateBouquetChannels(e)))}))}))},renameBouquetService:()=>{const n=u.selectedItems;if(1!==n.length)return!1;const s=n[0];if(2==s.dataset.ismarker)return!1;const o=s.dataset.sname,a=s.dataset.sref,r=jQuery(s).next().data("sref")||"",i=l.selectedItems[0].dataset.sref;swal({title:tstr_bqe_rename_marker,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!0,inputValue:o,input:"text",animation:"none"},(n=>{if(!n||n==o)return!1;const s=t.buildUrl("/bouqueteditor/api/renameservice",{sBouquetRef:i,sRef:a,newName:n,sRefBefore:r});e(s).then((()=>{t.changeBouquet(i).then((e=>t.populateBouquetChannels(e)))}))}))},searchChannels:e=>{i.isLoading=!0,t.filterChannelsCache=t.allChannelsCache.filter((t=>{if(t.containsText(e))return t})),t.populateChannels()},showError:(e,t)=>{console.debug(e,t),t=void 0!==t?t:"False",jQuery("#statustext").text(""),!0===t||"True"===t||"true"===t?(jQuery("#statusbox").removeClass("ui-state-error").addClass("ui-state-highlight"),jQuery("#statusicon").removeClass("ui-icon-alert").addClass("ui-icon-info")):(jQuery("#statusbox").removeClass("ui-state-highlight").addClass("ui-state-error"),jQuery("#statusicon").removeClass("ui-icon-info").addClass("ui-icon-alert")),jQuery("#statustext").text(e),""!==e?jQuery("#statuscont").show():jQuery("#statuscont").hide()},exportBouquets:()=>{swal({title:tstr_bqe_filename,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!0,inputValue:"bouquets_backup",input:"text",animation:"none"},(n=>{if(!n)return!1;const s=t.buildUrl("/bouqueteditor/api/backup",{Filename:n});e(s).then((e=>{window.open(`/bouqueteditor/tmp/${e[1]}`,"Download")}))}))},importBouquets:()=>{document.forms.uploadrestore.elements.rfile.click()},prepareRestore:n=>{const s=n.target,o=s.form,a=s.value.replace("C:\\fakepath\\","");swal({title:tstr_bqe_restore_question,text:a,type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes_delete,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!0,closeOnCancel:!0,animation:"none"},(n=>{if(n){const n=new FormData(o);e(o.action,{method:o.method,body:n}).then((e=>t.doRestore(e[1])))}}))},doRestore:n=>{if(!n)return!1;const s=t.buildUrl("/bouqueteditor/api/restore",{Filename:n});e(s).then((()=>{t.getBouquets().then((e=>t.populateBouquets(e)))}))},initEventHandlers:()=>{const e=document.getElementById("bqemain");let n=document.createElement("a");(document.getElementById("toolbar-bouquets-reload")||n).onclick=()=>{console.log("fixme"),t.getBouquets().then((e=>t.populateBouquets(e)))},(document.getElementById("toolbar-bouquets-export")||n).onclick=t.exportBouquets,(document.getElementById("toolbar-bouquets-import")||n).onclick=t.importBouquets,e.querySelectorAll('input[name="cType"]').forEach((e=>{e.onchange=()=>t.changeTvRadioMode()})),e.querySelectorAll('input[name="tvRadioMode"]').forEach((e=>{e.onchange=()=>t.changeTvRadioMode()})),(e.querySelector('button[name="createBqFromProvider"]')||n).onclick=t.addProviderAsBouquet,(e.querySelector('button[name="addChannelToBq"]')||n).onclick=t.addChannel,(e.querySelector('button[name="newBq"]')||n).onclick=t.addBouquet,(e.querySelector('button[name="renameBq"]')||n).onclick=t.renameBouquet,(e.querySelector('button[name="deleteBq"]')||n).onclick=t.deleteBouquet,(e.querySelector('button[name="addUrl"]')||n).onclick=t.addUrl,(e.querySelector('button[name="addMarker"]')||n).onclick=t.addMarker,(e.querySelector('button[name="addSpacer"]')||n).onclick=t.addSpacer,(e.querySelector('button[name="renameService"]')||n).onclick=t.renameBouquetService,(e.querySelector('button[name="removeService"]')||n).onclick=t.deleteChannel,(e.querySelector('input[name="searchChannelsQuery"]')||n).addEventListener("keyup",(e=>{t.searchChannels(e.target.value)})),n=null,jQuery("#rfile").change(t.prepareRestore)},init:function(){t=this,r.selectable({selected:(e,n)=>{t.changeProvider(jQuery(n.selected).data("sref")).then((()=>t.populateChannels()))},selecting:(e,t)=>{jQuery(t.selecting).siblings().removeClass("ui-selecting")},stop:t.setProviderButtonsState}),i.selectable({filter:"li",stop:t.setChannelButtonsState}),l.sortable({axis:"y",handle:".handle",stop:(e,n)=>{const s=jQuery(n.item).data("sref"),o=jQuery(n.item).index();t.moveBouquet({sBouquetRef:s,mode:t.getSelectedTvRadioMode(),position:o})}}).selectable({filter:"li",cancel:".handle, a, button",selected:(e,n)=>{t.changeBouquet(jQuery(n.selected).data("sref")).then((e=>t.populateBouquetChannels(e)))},selecting:(e,t)=>{jQuery(t.selecting).siblings().removeClass("ui-selecting")}}),u.sortable({axis:"y",handle:".handle",stop:(e,n)=>{const s=l.selectedItems[0].dataset.sref,o=jQuery(n.item).data("sref"),a=n.item.index();t.moveChannel({sBouquetRef:s,sRef:o,mode:t.getSelectedTvRadioMode(),position:a})}}).selectable({filter:"li",cancel:".handle, a, button",stop:t.setBouquetChannelButtonsState}),t.initEventHandlers(t),t.changeTvRadioMode()}}}).init()}();
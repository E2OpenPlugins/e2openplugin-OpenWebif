/*! For license information please see autotimers-app.js.LICENSE.txt */
!function(){"use strict";function e(e=""){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function t(e){let t=[];return Array.isArray(e)?t=e:void 0!==e&&(t=[e]),t}function n(e,t){const{hours:n=0,minutes:a=0}=t;try{const t=e.split(":"),o=parseInt(t[0]),r=parseInt(t[1]),i=new Date(0,0,0,o,r);return i.setHours(o+n),i.setMinutes(r+a),i.toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit"})}catch(t){return e}}function a(e){document.querySelectorAll(e).forEach((e=>{e.remove()}))}function o(e,t,n,a){const o=t.namedItem(n);if(o)if(owif.utils.debugLog(`[${o.type}]`,o,n,a),o instanceof RadioNodeList){const e=a.split(",");for(const[t,r]of o.entries()){r.value=e[t]||"";try{r.dispatchEvent(new Event("change"))}catch(e){owif.utils.debugLog(n,a,e)}}}else{switch(o.type){case"checkbox":a=!0===a||"True"===a||a.toString()===o.value,o.checked=a;break;case"select-multiple":try{const t=a.map((e=>e.sRef));e.autoTimerChoices[n].setChoices(a,"sRef","name",!1).setChoices(a,"label","value",!1).removeActiveItems().setChoiceByValue(a).setChoiceByValue(t)}catch(e){owif.utils.debugLog(n,a,e)}break;default:o.value=a}try{o.dispatchEvent(new Event("change"))}catch(e){owif.utils.debugLog(n,a,e)}}else if(owif.utils.debugLog("%c[N/A]","color: red",n,a),"filters"!==n){const e=document.createElement("input");e.type="hidden",e.name=n,e.value=a,e.dataset.valueType=typeof a,t[0].form.prepend(e)}}function r(e,t){try{e.classList.toggle("dependent-section--disabled",t),e.querySelectorAll("input, select").forEach((e=>{e.disabled=t}))}catch(e){}}class i{constructor(n){const a=this;if(Object.assign(a,n),a.name=e(a.name),a.match=e(a.match),a.tag=[],a.bouquets=[],a.services=[],a.filters={include:[],exclude:[]},a.enabled="yes"===a.enabled?1:0,a.from&&(a.timespanFrom=a.from,delete a.from),a.to&&(a.timespanTo=a.to,delete a.to),a.after){const e=new Date(1e3*parseInt(a.after));a.after=e.toISOString().split("T")[0]}if(a.before){const e=new Date(1e3*parseInt(a.before));a.before=e.toISOString().split("T")[0]}if(a.afterevent){const e={shutdown:"deepstandby"},t=a.afterevent.from,n=a.afterevent.to,o=a.afterevent["_@ttribute"];t&&(a.aftereventFrom=t),n&&(a.aftereventTo=n),o&&(a.afterevent=e[o]||o)}if(a.e2service){let e=!1;t(a.e2service).forEach(((t,n)=>{const o=owif.utils.isBouquet(t.e2servicereference)?"bouquets":"services";a[o].push({sRef:t.e2servicereference,name:t.e2servicename,selected:!0}),e=!t.e2servicename})),a.hasMismatchedService=e,delete a.e2service}a.e2tag&&(a.tag=t(a.e2tag),delete a.e2tag),a.e2tags&&(a.tag||(a.tag=a.e2tags.split(" ")),delete a.e2tags),a.include&&(a.filters.include=t(a.include),delete a.include),a.exclude&&(a.filters.exclude=t(a.exclude),delete a.exclude),a.vps_safemode=!a.vps_overwrite}get bouquetSRefs(){return this.bouquets.map((e=>e.sRef))}get bouquetNames(){return this.bouquets.map((e=>e.name))}get channelSRefs(){return this.services.map((e=>e.sRef))}get channelNames(){return this.services.map((e=>e.name))}get isRestrictedByDay(){return this.filters.include.filter((e=>"dayofweek"===e.where)).length+this.filters.exclude.filter((e=>"dayofweek"===e.where)).length>0}}(new function(){let e;const s=document.querySelector('form[name="atedit"]'),l=document.querySelector('form[name="atsettings"]'),c=(e,t="")=>{const n=e.insertCell();return n.innerHTML=t,n};return{getAll:async()=>{const n=(await owif.utils.fetchData("/autotimer")).autotimer;return owif.utils.debugLog(n),e.allAutoTimers=t(n.timer),e.allAutoTimers.map((e=>new i(e))),e.allAutoTimers.sort(function(e,t="asc"){return function(n,a){if(!n.hasOwnProperty(e)||!a.hasOwnProperty(e))return 0;const o="string"==typeof n[e]?n[e].toUpperCase():n[e],r="string"==typeof a[e]?a[e].toUpperCase():a[e];let i=0;return o>r?i=1:o<r&&(i=-1),"desc"===t?-1*i:i}}("name")),e.allAutoTimers},populateList:()=>{const t=document.getElementById("at__list");a(".at__item"),document.getElementById("at__page--edit").classList.toggle("hidden",!0),window.scroll({top:0,left:0,behavior:"smooth"}),document.getElementById("at__page--list").classList.toggle("hidden",!1);const n=document.getElementById("autotimer-list-item-template");let o=[],r=[];e.getAll().then((a=>{a.forEach(((a,s)=>{(a=new i(a)).location&&o.push(a.location),r=r.concat(a.tag);const l=valueLabelMap.autoTimers.searchType[a.searchType]||"",c=n.content.firstElementChild.cloneNode(!0);c.querySelector('[name="preview"]').onclick=t=>e.preview(a.id),c.querySelector('[name="rename"]').onclick=t=>e.renameEntry(a.id,a.name);const u=c.querySelector('a[href="/#/at/edit?id={{id}}"]');u.href=u.href.replace("{{id}}",a.id),u.onclick=t=>{e.editEntry(a.id)},c.querySelector('button[name="toggle"]').onclick=t=>e.toggleEntryEnabled(a.id,a.enabled),c.querySelector('button[name="delete"]').onclick=t=>e.deleteEntry(a.id),c.querySelector('slot[name="autotimer-name"]').innerHTML=a.name,c.querySelector(".icon__state").textContent=a.enabled?"av_timer":"highlight_off",c.querySelector('slot[name="autotimer-searchType"]').innerHTML=l?`${l}:`:"",a.timespanFrom&&(c.querySelector('slot[name="autotimer-timespan"]').innerHTML=`~ ${a.timespanFrom||""} - ${a.timespanTo||""}`),a.isRestrictedByDay&&(c.querySelector('slot[name="autotimer-filters"]').innerHTML="Certain days"),c.querySelector('slot[name="autotimer-channels"]').innerHTML=a.channelNames.join(", "),a.bouquetNames.length&&(c.querySelector('slot[name="autotimer-bouquets"]').innerHTML=`<br> ${a.bouquetNames.join(", ")}`),c.querySelector('slot[name="autotimer-match"]').innerHTML=`"${a.match}"`,t.appendChild(c)})),e.allLocations=[...new Set(e.availableLocations.concat(o))].sort()||[],e.allTags=[...new Set(e.availableTags.concat(r))].sort()||[]}))},getSettings:async()=>{const t="config.plugins.autotimer.";let n=(await owif.utils.fetchData("/autotimer/get")).e2settings.e2setting;const{elements:a}=l;n=n.filter((e=>e.e2settingname.startsWith(t))).map((e=>{for(const[t,n]of Object.entries(e))e[t.replace("e2setting","")]=n,delete e[t];return e.name=e.name.replace(t,""),e}));for(let t of Object.values(n))o(e,a,t.name,t.value)},saveSettings:async()=>{const e=new FormData(l);for(const[t,n]of Object.entries(l))"checkbox"!==n.type||e.has(n.name)||e.set(n.name,"");try{const t=(await owif.utils.fetchData("/autotimer/set",{method:"post",body:e})).e2simplexmlresult,n=t.e2state;let a=t.e2statetext;if(a=`${a.charAt(0).toUpperCase()}${a.slice(1)}`,!0!==n&&"true"!==n.toString().toLowerCase())throw new Error(a)}catch(e){swal({title:tstr_oops,text:e,type:"error",animation:"none"})}},process:async()=>{try{owif.utils.debugLog("`process` started, this could take a while...");const e=(await owif.utils.fetchData("/autotimer/parse")).e2simplexmlresult,t=e.e2state;let n=e.e2statetext;if(n=`${n.charAt(0).toUpperCase()}${n.slice(1)}`,!0!==t&&"true"!==t.toString().toLowerCase())throw new Error(n);swal({title:"result",text:n,type:"info",animation:"none"})}catch(e){swal({title:tstr_oops,text:e.message,type:"error",animation:"none"})}},previewAll:()=>{e.preview()},preview:async(e="")=>{const t=document.getElementById("at-preview__list"),n=document.getElementById("at-preview__no-results"),a=document.getElementById("at-preview__progress");t.querySelectorAll("tr").forEach((e=>e.remove())),n.classList.toggle("hidden",!0),a.classList.toggle("hidden",!1);const o=e&&`test?id=${e}`||"simulate",r=await owif.utils.fetchData(`/autotimer/${o}`),i=r.e2autotimersimulate||r.e2autotimertest,s=i.e2simulatedtimer||i.e2testtimer||[],l=document.createElement("tbody");a.classList.toggle("hidden",!0),s.forEach((e=>{((e,t)=>{const n=e.insertRow(),a=t.e2state;c(n,a).title="Skip"===a?t.e2message:"",c(n,t.e2autotimername),c(n,t.e2name),c(n,t.e2servicename);const o=t.e2timebegin;c(n,owif.utils.getStrftime(o)).style.textAlign="right";const r=t.e2timeend;c(n,owif.utils.getToTimeText(o,r)).style.textAlign="right"})(l,e)})),s.length?t.innerHTML=l.cloneNode(!0).innerHTML:n.classList.toggle("hidden",!1)},prepareChoices:()=>{e.allTags=e.allTags.map((e=>({value:e,label:e}))),e.autoTimerChoices.tag.setChoices(e.allTags,"value","label",!0),e.autoTimerChoices.bouquets.setChoices(e.availableServices.bouquets,"sRef","name",!0),e.autoTimerChoices.services.setChoices(e.availableServices.channels,"sRef","extendedName",!0)},populateForm:async(t={})=>{owif.utils.debugLog(t);const{elements:n}=s;s.reset(),a(".at__filter__line"),document.getElementById("at__page--list").classList.toggle("hidden",!0),window.scroll({top:0,left:0,behavior:"smooth"}),document.getElementById("at__page--edit").classList.toggle("hidden",!1),t=((e={})=>(e._timespan=!!e.timespanFrom||!!e.timespanTo,e._datespan=!!e.after||!!e.before,e._after=!!e.after,e._before=!!e.before,e._timerOffset=!!e.offset,e.timeSpanAE=!!e.afterevent,e._location=!!e.location,e))(t=new i(t)),e.prepareChoices();for(let t of e.allLocations){const e=document.createElement("option");e.appendChild(document.createTextNode(t)),e.value=t,document.querySelector('select[name="location"] optgroup[name="more"').appendChild(e),jQuery("select[name=location]").selectpicker("refresh")}for(let[a,r]of Object.entries(t))o(e,n,a,r);e.populateFilters(t.filters)},deleteEntry:async(t=-1)=>{-1!==t&&swal({title:tstr_del_autotimer,type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes_delete,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!0,closeOnCancel:!0,animation:"none"},(async n=>{if(n){const n=(await owif.utils.fetchData(`/autotimer/remove?id=${t}`)).e2simplexmlresult,a=n.e2state;let o=n.e2statetext;o=`${o.charAt(0).toUpperCase()}${o.slice(1)}`,!0===a||"true"===a.toString().toLowerCase()?swal({title:tstrings_deleted,text:o,type:"success",animation:"none"}):swal({title:tstr_oops,text:o,type:"error",animation:"none"}),e.populateList()}else swal({title:tstrings_cancelled,type:"error",animation:"none"})}))},toggleEntryEnabled:async(t=-1,n)=>{const a=1==n?0:1;try{const o=(await owif.utils.fetchData(`/autotimer/change?id=${t}&enabled=${a}`)).e2simplexmlresult,r=o.e2state;let i=o.e2statetext;if(i=`${i.charAt(0).toUpperCase()}${i.slice(1)}`,!0!==r&&"true"!==r.toString().toLowerCase())throw new Error(i);swal.close(),e.populateList(),owif.utils.debugLog(`toggleEntryEnabled [id ${t}] from ${n} to ${a} successful`)}catch(e){swal({title:tstr_oops,text:e.message,type:"error",animation:"none"})}},createEntry:()=>e.populateForm(),renameEntry:(t=-1,n,a="")=>{const o=async(t,a)=>{try{const o=(await owif.utils.fetchData(`/autotimer/change?id=${t}&name=${a}`)).e2simplexmlresult,r=o.e2state;let i=o.e2statetext;if(i=`${i.charAt(0).toUpperCase()}${i.slice(1)}`,!0!==r&&"true"!==r.toString().toLowerCase())throw new Error(i);swal.close(),e.populateList(),owif.utils.debugLog(`renameEntry [id ${t}] from ${n} to ${a} successful`)}catch(e){swal({title:tstr_oops,text:e.message,type:"error",animation:"none"})}};a?o(t,a):swal({title:tstr_rename,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!1,inputValue:n,input:"text",animation:"none"},(e=>{e&&e.length&&o(t,e)}))},editEntry:async(t=-1)=>{const n=e.allAutoTimers.find((e=>e.id==t));owif.utils.debugLog(`editEntry: ${n}`),e.populateForm(n)},transformFormData:()=>{const e=new FormData(s),t=Object.fromEntries(e),n=["title","shortdescription","description","dayofweek","!title","!shortdescription","!description","!dayofweek"],a=n.concat(["enabled","offset","services","bouquets","vps_enabled"]),o=["offset","services","bouquets"];return window.disableFilterEditing&&n.forEach((t=>e.delete(t))),["hasMismatchedService","_before","_after","_type","_filterpredicate","_filterwhere"].forEach((t=>e.delete(t))),Object.entries(t).forEach((([t,n])=>{owif.utils.debugLog(t,n),o.includes(t)&&e.set(t,e.getAll(t)),""===n||","===n?e.delete(t):owif.utils.regexDateFormat.test(n)&&e.set(t,owif.utils.toUnixDate(n))})),a.forEach((t=>{e.has(t)||e.set(t,"")})),e},saveEntry:async(t="")=>{const n=(await owif.utils.fetchData(`/autotimer/edit?${t}`,{method:"post",body:e.transformFormData()})).e2simplexmlresult,a=n.e2state;let o=n.e2statetext;o=`${o.charAt(0).toUpperCase()}${o.slice(1)}`,!0===a||"true"===a.toString().toLowerCase()?e.populateList():swal({title:tstr_oops,text:o,type:"error",animation:"none"})},cancelEntry:()=>{swal({title:tstr_prompt_save_changes,type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!1,closeOnCancel:!0,animation:"none"},(function(t){t?e.saveEntry():(window.location.hash="/at",e.populateList())}))},populateFilters:t=>{t.exclude.forEach((t=>{t.predicate="!",t.value=t["_@ttribute"],delete t["_@ttribute"],e.addFilter(t)})),t.include.forEach((t=>{t.predicate="",t.value=t["_@ttribute"],delete t["_@ttribute"],e.addFilter(t)}))},addFilter:(t={predicate:"",where:"title",value:""})=>{const n=document.getElementById("autotimer-filter-template").content.firstElementChild.cloneNode(!0),a=document.getElementById("atform__filters-container"),o=n.querySelector('select[name="_filterpredicate"]'),r=n.querySelector('select[name="_filterwhere"]'),i=n.querySelector('input[type="text"]'),s=n.querySelector('select[name="dayofweek"]'),l=()=>{"dayofweek"===r.value?(s.name=`${o.value}${r.value}`,i.value=""):(i.name=`${o.value}${r.value}`,s.value="")};if(n.querySelector('button[name="removeFilter"]').onclick=e.removeFilter,o.onchange=e=>{l()},r.onchange=e=>{const t=e.target,n=t.closest("fieldset"),a="dayofweek"===t.value;n.querySelector(".filter-value--dayofweek").classList.toggle("hidden",!a),n.querySelector(".filter-value--text").classList.toggle("hidden",a),l()},o.value=t.predicate,r.value=t.where,"dayofweek"===t.where){const e=t.value.split(",");for(let t of s)t.selected=e.includes(t.value);r.dispatchEvent(new Event("change"))}else i.value=t.value;l(),a.appendChild(n),jQuery.AdminBSB.select.activate()},removeFilter:()=>{event.target.closest("fieldset.at__filter__line").remove()},initEventHandlers:()=>{let t=document.createElement("input");(document.querySelector('button[name="reload"]')||t).onclick=e.populateList,(document.querySelector('button[name="process"]')||t).onclick=e.process,(document.querySelector('button[name="previewAll"]')||t).onclick=e.previewAll,(document.querySelector('button[name="timers"]')||t).onclick=()=>window.listTimers(),(document.querySelector('button[name="settings"]')||t).onclick=e.getSettings,(document.querySelector('button[name="saveSettings"]')||t).onclick=e.saveSettings,(document.querySelector('a[href="/#/at/new"]')||t).onclick=e.createEntry,(document.querySelector('button[name="addFilter"]')||t).onclick=()=>e.addFilter(),(document.querySelector('button[name="cancel"]')||t).onclick=e.cancelEntry,(document.querySelector('form[name="atedit"]')||t).onsubmit=t=>{t.preventDefault(),e.saveEntry()},(document.querySelectorAll('input[name="justplay"], input[name="always_zap"]')||t).forEach((e=>{e.onchange=e=>{document.querySelectorAll('input[name="justplay"]:checked, input[name="always_zap"]:checked').length<1&&(event.target.checked=!event.target.checked)}})),(document.getElementById("_timespan")||t).onchange=e=>{r(document.getElementById("_timespan_"),!e.target.checked)},(document.getElementById("_datespan")||t).onchange=e=>{r(document.getElementById("_datespan_"),!e.target.checked)},(document.getElementById("_timerOffset")||t).onchange=e=>{r(document.getElementById("_timerOffset_"),!e.target.checked)},(document.querySelector('[name="afterevent"]')||t).onchange=e=>{r(document.getElementById("AftereventE"),!e.target.value)},(document.getElementById("timeSpanAE")||t).onchange=e=>{r(document.getElementById("timeSpanAEE"),!e.target.checked)},(document.getElementById("_location")||t).onchange=e=>{r(document.getElementById("_location_"),!e.target.checked)},(document.getElementById("beforeevent")||t).onchange=e=>{r(document.getElementById("BeforeeventE"),!e.target.checked)},(document.querySelector('[name="vps_enabled"]')||t).onchange=e=>{r(document.getElementById("vps_enabled_"),!e.target.checked)},(document.querySelector('[name="vps_safemode"]')||t).onchange=e=>{(document.querySelector('[name="vps_overwrite"]')||t).value=e.target.checked?0:1}},init:async function(){e=this,e.allAutoTimers=[],e.availableServices=await owif.api.getAllServices(!0,!0),e.availableLocations=[],e.allLocations=[],e.availableTags=await owif.api.getTags(),e.allTags=[],e.autoTimerChoices=owif.gui.preparedChoices();const t=window.location.hash;if(t.startsWith("/#/at/new")){const a=new URLSearchParams(t.split("?")[1]||""),o=Object.fromEntries(a);o.timespanFrom&&(o.timespanFrom=n(o.timespanFrom,{hours:-1})),o.timespanTo&&(o.timespanTo=n(o.timespanTo,{hours:1})),o.sref&&(o.e2service={e2servicereference:o.sref}),e.populateForm(o)}else if(t.startsWith("/#/at/edit")){const n=new URLSearchParams(t.split("?")[1]||"");e.editEntry(n.get("id"))}else e.populateList();e.initEventHandlers(e)}}}).init()}();